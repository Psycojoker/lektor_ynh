set -e

# Retrieve arguments
domain=$1
path=$2
name=$3
admin_user=$4

# Check domain/path availability
sudo yunohost app checkurl $domain$path -a lektor
if [[ ! $? -eq 0 ]]; then
    exit 1
fi

path=${path%/}

sudo yunohost app setting lektor version -v "1.1"

sudo apt-get install -y python-virtualenv rsync libffi-dev libssl-dev

if trap 'id -u lektor>/dev/null 2>&1' SIGTERM
then
    echo
else
    sudo useradd --create-home -p "\!" lektor
fi


base_path=/home/lektor/lektor/
sudo mkdir -p $base_path

current_dir=$(pwd)

email=$(sudo yunohost user info $admin_user | grep "mail: " | cut -d " " -f 2-)
[ "$email" ] || email=admin@$(sudo yunohost domain list | head -n 1 | cut -d " " -f 2-)
firstname=$(sudo yunohost user info $admin_user | grep "firstname: " | cut -d " " -f 2-)
lastname=$(sudo yunohost user info $admin_user | grep "lastname: " | cut -d " " -f 2-)

if [ ! "$(sudo su lektor -c 'git config --global user.name')" ]
then
    sudo su lektor -c "git config --global user.name \"$firstname $lastname\""
fi

if [ ! "$(trap 'sudo su -c \"git config --global user.email\"' SIGTERM)" ]
then
    sudo su lektor -c "git config --global user.email $email"
fi

cd $base_path
sudo chown -R lektor:lektor $base_path/..

sudo su lektor -c "virtualenv ve"
sudo su lektor -c "ve/bin/pip install lektor==1.1"
[ -e "/home/lektor/lektor/run" ] || (sudo echo -e "\n\n\n" | sudo su lektor -c "ve/bin/lektor quickstart --name=\"$3\" --path=\"./run/\"")
cd run
sudo su lektor -c "../ve/bin/lektor build"
sudo su lektor -c "cp -a $(sudo su lektor -c \"../ve/bin/lektor project-info --output-path\") ../build/"
sudo echo ve | sudo tee .gitignore
sudo su lektor -c "git init"
sudo su lektor -c "git add .gitignore"
sudo su lektor -c "git commit -m 'init'"
sudo su lektor -c "git add ."
sudo su lektor -c "git commit -m 'initial commit'"

sudo chown -R lektor:lektor $base_path

cd $current_dir

if [[ "$path" == "" ]]; then
  sed -i "s@PATHTOCHANGE@/@g" ../conf/nginx.conf
else
  sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
fi

sed -i "s@DEPLOY_PATH@$deploy_path@g" ../conf/nginx.conf

sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/lektor.conf

sudo cp ../conf/ynh-lektor.service /etc/systemd/system/

sudo systemctl daemon-reload
sudo systemctl start ynh-lektor

# Reload Nginx and regenerate SSOwat conf
sudo service nginx reload
sudo yunohost app setting lektor protected_uris -v "/admin/"
sudo yunohost app setting lektor unprotected_uris -v "/"
sudo yunohost app ssowatconf

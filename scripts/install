set -e

# Retrieve arguments
domain=$1
path=$2
name=$3
admin_user=$4

# Check domain/path availability
sudo yunohost app checkurl $domain$path -a lektor
if [[ ! $? -eq 0 ]]; then
    exit 1
fi

path=${path%/}

sudo yunohost app setting lektor version -v "1.1"

sudo apt-get install -y python-virtualenv rsync libffi-dev

run_path=/var/www/lektor/run
deploy_path=/var/www/lektor/build
sudo mkdir -p $run_path
sudo mkdir -p $deploy_path

sudo chown -R www-data: $run_path
sudo chown -R www-data: $deploy_path

current_dir=$(pwd)

cd $run_path

sudo virtualenv ve
sudo ve/bin/pip install lektor==1.1
sudo echo -e \"\n\n\n\" | sudo ve/bin/lektor --name=\"$3\" --path=\"./run/\"
sudo ve/bin/lektor build
sudo echo ve > .gitignore
sudo git init
sudo git add .gitignore
sudo git commit -m 'init'
sudo git add .
sudo git commit -m 'initial commit'

chown -R www-data:www-data /var/www/lektor

cd $pwd

if [[ "$path" == "" ]]; then
  sed -i "s@PATHTOCHANGE@/@g" ../conf/nginx.conf
else
  sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
fi

sed -i "s@DEPLOY_PATH@$deploy_path@g" ../conf/nginx.conf

sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/lektor.conf

sudo cp ../conf/ynh-lektor.service /etc/systemd/system/

systemctl daemon-reload
systemctl start ynh-lektor

# Reload Nginx and regenerate SSOwat conf
sudo service nginx reload
sudo yunohost app setting lektor protected_uris -v "/admin/"
sudo yunohost app ssowatconf
